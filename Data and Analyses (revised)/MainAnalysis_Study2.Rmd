---
title: "Prejudice and Narcissism"
author: "Matthias Ziegler"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---


# Preps

Here I am reading the data and looking at the structure.

```{r}

library(lavaan)
source(paste0(getwd(), "/CFA_functions_Matthias.R"))

dat <- rio::import(paste0(getwd(),"/Study2.sav"))

psych::describe(dat)
psych::describeBy(dat, group = "group")
psych::corr.test(dat)
```

# Model building

Now I am building model for T0 and T1.

```{r}
prejudicest0 <- grep("t0", names(dat), value=TRUE)[c(1:4)]
pre.t0 <- paste("pre.t0=~", paste(prejudicest0, collapse = "+"), sep="")
cat(pre.t0)

prejudicest1 <- grep("t1", names(dat), value=TRUE)[c(1:4)]
pre.t1 <- paste("pre.t1=~", paste(prejudicest1, collapse = "+"), sep="")
cat(pre.t1)

```


# Longitudinal model
## Models

```{r}
long.conf <- "
pre.t0=~ant_t0+sexT_t0+homo_t0+PreUK_t0
pre.t1=~ant_t1+sexT_t1+homo_t1+PreUK_t1

pre.t1~~pre.t0

ant_t0~~ant_t1
sexT_t0~~sexT_t1
homo_t0~~homo_t1
PreUK_t0~~PreUK_t1
"

long.wf <- "
pre.t0=~a*ant_t0+b*sexT_t0+c*homo_t0+d*PreUK_t0
pre.t1=~a*ant_t1+b*sexT_t1+c*homo_t1+d*PreUK_t1

pre.t1~~pre.t0

ant_t0~~ant_t1
sexT_t0~~sexT_t1
homo_t0~~homo_t1
PreUK_t0~~PreUK_t1
"

long.sf <- "
pre.t0=~a*ant_t0+b*sexT_t0+c*homo_t0+d*PreUK_t0
pre.t1=~a*ant_t1+b*sexT_t1+c*homo_t1+d*PreUK_t1

pre.t1~~pre.t0

ant_t0~~ant_t1
sexT_t0~~sexT_t1
homo_t0~~homo_t1
PreUK_t0~~PreUK_t1

ant_t0 ~ ai*1
sexT_t0 ~ bi*1
homo_t0 ~ ci*1
PreUK_t0 ~ di*1

ant_t1 ~ ai*1
sexT_t1 ~ bi*1
homo_t1 ~ ci*1
PreUK_t1 ~ di*1

pre.t1~NA*1

"
```

## Model test
```{r}
fit.conf.long <- cfa(long.conf,data=dat, estimator="mlr")
getFit(fit.conf.long)
summary(fit.conf.long, standardized =TRUE, fit.measures=TRUE)
omega2(fit.conf.long)

fit.wf.long <- cfa(long.wf,data=dat, estimator="mlr")
getFit(fit.wf.long)
summary(fit.wf.long, standardized =TRUE, fit.measures=TRUE)
omega2(fit.wf.long)

fit.sf.long <- cfa(long.sf,data=dat, estimator="mlr")
getFit(fit.sf.long)
summary(fit.sf.long, standardized =TRUE, fit.measures=TRUE)
omega2(fit.sf.long)
```

So, the longitudinal model is invariant on the scalar level. Now I will specify and test a latent change score model.

## Latent change score model
```{r}
lcsm <- "
#Building parts
pre.t0=~a*ant_t0+b*sexT_t0+c*homo_t0+d*PreUK_t0
pre.t1=~a*ant_t1+b*sexT_t1+c*homo_t1+d*PreUK_t1

ant_t0~~ant_t1
sexT_t0~~sexT_t1
homo_t0~~homo_t1
PreUK_t0~~PreUK_t1

ant_t0 ~ ai*1
sexT_t0 ~ bi*1
homo_t0 ~ ci*1
PreUK_t0 ~ di*1

ant_t1 ~ ai*1
sexT_t1 ~ bi*1
homo_t1 ~ ci*1
PreUK_t1 ~ di*1

#Actual model

pre.t1~1*pre.t0
pre.t1~~0*pre.t1

delta=~1*pre.t1

delta~pre.t0

delta~NA*1
"


```

## LCSM test
```{r}
fit.lcsm <- cfa(lcsm,data=dat, estimator="mlr")
getFit(fit.lcsm)
summary(fit.lcsm, standardized =TRUE, fit.measures=TRUE, rsquare=TRUE)

```

So, that model works nicely. Now, I will not split into a multiple group model (too few cases). Instead, I will regress the change score (delta) on the group variable (like a t test).

## Group differences
### Model
```{r}
lcsm.group <- paste(lcsm, "delta~group", sep="\n")
cat(lcsm.group)
```

### Model test
```{r}
fit.lcsm.group <- cfa(lcsm.group,data=dat, estimator="mlr")
getFit(fit.lcsm.group)
summary(fit.lcsm.group, standardized =TRUE, fit.measures=TRUE, rsquare=TRUE)
```

The regression weight is significant and negative. This would mean that group 1 has a significantly lower score than group 0. 

Now, I will also include narcissism.

## Role of narcissism
First I will define a moderator term.

```{r}
#dat$CN_t0 <- as.numeric(dat$CN_t0)
dat$CNbyGroup <- scale(dat$CN_t0, center=TRUE, scale = FALSE)*scale(dat$group, center=TRUE, scale = FALSE)
```


### Model
```{r}
lcsm.group.n <- paste(lcsm.group, "delta~CN_t0", "delta~CNbyGroup", "CN_t0~~pre.t0", sep="\n")
cat(lcsm.group.n)
```

### Model test
```{r}
fit.lcsm.group.n <- cfa(lcsm.group.n,data=dat, estimator="mlr")
getFit(fit.lcsm.group.n)
summary(fit.lcsm.group.n, standardized =TRUE, fit.measures=TRUE, rsquare=TRUE)

# squared standard errors
.133^2 #delta ~1 (intercept - b0)
.049^2 #CN _t0  (b1)
.053^2 #group (b2)
.057^2 #CN X Group (b3)
# covariances
vcov(fit.lcsm.group.n)["delta~group", "delta~1"]
vcov(fit.lcsm.group.n)["delta~CNbyGroup", "delta~CN_t0"]

# 95% Confidence interval information for all parameters
parameterestimates(fit.lcsm.group.n, ci=TRUE, level=.95)
# 95% Confidence interval information for teh change score parameters only
s <- subset(parameterestimates(fit.lcsm.group.n, ci=TRUE, level=.95, standardized = T), parameterestimates(fit.lcsm.group.n, ci=TRUE)$lhs=="delta")

```

## Moderation figure according to Preacher

       TWO-WAY INTERACTION SIMPLE SLOPES OUTPUT

Your Input
=======================================================
  X1        = -2
  X2        = 2
  cv1       = 0
  cv2       = 1
  Intercept = 0.185
  X Slope   = 0.038
  Z Slope   = -0.301
  XZ Slope  = -0.271
  df        = 43
  alpha     = 0.05

Asymptotic (Co)variances
=======================================================
  var(b0) 0.017689
  var(b1) 0.002401
  var(b2) 0.002809
  var(b3) 0.003249
  cov(b2,b0) -0.00073069
  cov(b3,b1) 0.00003818

Simple Intercepts and Slopes at Conditional Values of Z
=======================================================
  At Z = cv1...
    simple intercept = 0.185(0.133), t=1.391, p=0.1714
    simple slope     = 0.038(0.049), t=0.7755, p=0.4423
  At Z = cv2...
    simple intercept = -0.116(0.138), t=-0.8407, p=0.4051
    simple slope     = -0.233(0.0757), t=-3.079, p=0.0036

Points to Plot
=======================================================
  Line for cv1:  From {X=-2, Y=0.109} to {X=2, Y=0.261}
  Line for cv2:  From {X=-2, Y=0.35} to {X=2, Y=-0.582}

*Regions of significance output suppressed because
 moderator is dichotomous.
```{r}
CI.up <- 0.038+1.96*0.049
CI.low <- 0.038-1.96*0.049

round(c(CI.low, .038, CI.up),2)
CI.up <- -0.233+1.96*0.0757
CI.low <- -0.233-1.96*0.0757

round(c(CI.low, -0.233, CI.up),2)

# [1] -0.38 -0.23 -0.08

```


```{r}
par(mfrow=c(1,1))
xx <- c(-2,2)   #  <-- change to alter plot dims
yy <- c(-0.7684,0.35)   #  <-- change to alter plot dims
leg <- c(-2,-0.4286)   #  <-- change to alter legend location
x <- c(-2,2)   #  <-- x-coords for lines
y1 <- c(0.109,0.261)
y2 <- c(0.35,-0.582)
plot(xx,yy,type='n',font=2,font.lab=2,xlab='Collective Narcissism',ylab='Model implied change in prejudice',main='', col=c("blue", "red"))
lines(x,y1,lwd=3,lty=1,col="blue")
lines(x,y2,lwd=3,lty=5,col="red")
points(x,y1,col=1,pch=16)
points(x,y2,col=1,pch=16)
legend(leg[1],leg[2],legend=c('Wait-List Control Condition','Mindful-Gratitude Practice'),lwd=c(3,3),lty=c(1,5),col=c("blue", "red"))


```






## Version 2
       TWO-WAY INTERACTION SIMPLE SLOPES OUTPUT

Your Input
=======================================================
  X1        = -2
  X2        = 2
  cv1       = -1
  cv2       = 0
  cv3       = 1
  Intercept = 0.185
  X Slope   = -0.301
  Z Slope   = 0.038
  XZ Slope  = -0.271
  df        = 43
  alpha     = 0.05

Asymptotic (Co)variances
=======================================================
  var(b0) 0.017689
  var(b1) 0.002809
  var(b2) 2401
  var(b3) 0.003249
  cov(b2,b0) -0.00630529
  cov(b3,b1) 0.00061679

Region of Significance
=======================================================
  Z at lower bound of region = -1.952
  Z at upper bound of region = -0.6735
  (simple slopes are significant *outside* this region.)

Simple Intercepts and Slopes at Conditional Values of Z
=======================================================
  At Z = cv1...
    simple intercept = 0.147(49.0003), t=0.003, p=0.9976
    simple slope     = -0.03(0.0695), t=-0.4319, p=0.668
  At Z = cv2...
    simple intercept = 0.185(0.133), t=1.391, p=0.1714
    simple slope     = -0.301(0.053), t=-5.6792, p=0
  At Z = cv3...
    simple intercept = 0.223(49.0001), t=0.0046, p=0.9964
    simple slope     = -0.572(0.0854), t=-6.6986, p=0

Simple Intercepts and Slopes at Region Boundaries
=======================================================
  Lower Bound...    
    simple intercept = 0.1108(95.6482), t=0.0012, p=0.9991
    simple slope     = 0.228(0.1131), t=2.0167, p=0.05
  Upper Bound...    
    simple intercept = 0.1594(33.0019), t=0.0048, p=0.9962
    simple slope     = -0.1185(0.0588), t=-2.0166, p=0.05

Points to Plot
=======================================================
  Line for cv1:  From {X=-2, Y=0.207} to {X=2, Y=0.087}
  Line for cv2:  From {X=-2, Y=0.787} to {X=2, Y=-0.417}
  Line for cv3:  From {X=-2, Y=1.367} to {X=2, Y=-0.921}

```{r}
vcov(fit.lcsm.group.n)["delta~CN_t0", "delta~1"]
vcov(fit.lcsm.group.n)["delta~CNbyGroup", "delta~group"]

xx <- c(0,1)   #  <-- change to alter plot dims
yy <- c(-1.3786,1.367)   #  <-- change to alter plot dims
leg <- c(0,-1.0354)   #  <-- change to alter legend location
x <- c(0,1)   #  <-- x-coords for lines
y1 <- c(0.207,0.087)
y2 <- c(0.787,-0.417)
y3 <- c(1.367,-0.921)
plot(xx,yy,type='n',font=2,font.lab=2,xlab='Group',ylab='Model implied change in prejudice',main='Interaction Plot', xaxt="n")
axis(1, las=1, at = c(0,1), labels = c("CG","EG"))
lines(x,y1,lwd=3,lty=1,col=1)
lines(x,y2,lwd=3,lty=5,col=2)
lines(x,y3,lwd=3,lty=6,col=3)
points(x,y1,col=1,pch=16)
points(x,y2,col=1,pch=16)
points(x,y3,col=1,pch=16)
legend(leg[1],leg[2],legend=c('below average CN','average CN','above average CN'),lwd=c(3,3,3),lty=c(1,5,6),col=c(1,2,3))

```


## Region of significance
```{r}
z1=0  #supply lower bound for z
z2=1   #supply upper bound for z
z <- seq(z1,z2,length=1000)
fz <- c(z,z)
y1 <- (-0.301+-0.271*z)+(2.0167*sqrt(0.002809+(2*z*0.0006167888)+((z^2)*0.003249)))
y2 <- (-0.301+-0.271*z)-(2.0167*sqrt(0.002809+(2*z*0.0006167888)+((z^2)*0.003249)))
fy <- c(y1,y2)
fline <- (-0.301+-0.271*z)
plot(fz,fy,type='p',pch='.',font=2,font.lab=2,col=2,xlab='Group',ylab='Simple Slope Change ~ CN',main='Confidence Bands', xaxt="n")
axis(1, las=1, at = c(0,1), labels = c("CG","EG"))
lines(z,fline)
f0 <- array(0,c(1000))
lines(z,f0,col=8)
abline(v=-1.952,col=4,lty=2)
abline(v=-0.6735,col=4,lty=2)

```


### All prereg moderators
```{r}
#cat(lcsm.group.n)
lcsm.group.n.all <- paste(lcsm.group.n, "delta~SI_t0+NPI_t0+RWA_t0+sdo_t0", sep="\n")
cat(lcsm.group.n.all)
fit.lcsm.group.n.all <- cfa(lcsm.group.n.all,data=dat, estimator="mlr", fixed.x = FALSE)
getFit(fit.lcsm.group.n.all)
summary(fit.lcsm.group.n.all, standardized =TRUE, fit.measures=TRUE, rsquare=TRUE)
# 90% Confidence interval information for all parameters
parameterestimates(fit.lcsm.group.n.all, ci=TRUE, level=.95)
# 90% Confidence interval information for teh change score parameters only
subset(parameterestimates(fit.lcsm.group.n.all, ci=TRUE, level=.95), parameterestimates(fit.lcsm.group.n, ci=TRUE)$lhs=="delta")
```

# Moderation figure
```{r}
fs <- lavPredict(fit.lcsm.group.n, se = "standard", type = "lv")
datfs <- cbind(dat, fs)

hist(datfs$delta)

means <- psych::describeBy(datfs$CN_t0, group=datfs$group)
lo0 <- means$`0`$mean-means$`0`$sd
up0 <- means$`0`$mean+means$`0`$sd


lo1 <- means$`1`$mean-means$`1`$sd
up1 <- means$`1`$mean+means$`1`$sd

group0 <- subset(datfs, datfs$group==0)
group1 <- subset(datfs, datfs$group==01)

group0$CN_level <- cut(group0$CN_t0, breaks=c(-Inf, lo0, up0, Inf))
table(group0$CN_level)
levels(group0$CN_level) <- c("bav", "av", "aav")
group1$CN_level <- cut(group1$CN_t0, breaks=c(-Inf, lo1, up1, Inf))
table(group1$CN_level)
levels(group1$CN_level) <- c("bav", "av", "aav")

g0t0bav <- mean(subset(group0, group0$CN_level=="bav")$"pre.t0")
g0t0av <- mean(subset(group0, group0$CN_level=="av")$"pre.t0")
g0t0aav <- mean(subset(group0, group0$CN_level=="aav")$"pre.t0")

g1t0bav <- mean(subset(group1, group1$CN_level=="bav")$"pre.t0")
g1t0av <- mean(subset(group1, group1$CN_level=="av")$"pre.t0")
g1t0aav <- mean(subset(group1, group1$CN_level=="aav")$"pre.t0")

g0t1bav <- mean(subset(group0, group0$CN_level=="bav")$"pre.t0")+mean(subset(group0, group0$CN_level=="bav")$"delta")
g0t1av <- mean(subset(group0, group0$CN_level=="av")$"pre.t0")+mean(subset(group0, group0$CN_level=="av")$"delta")
g0t1aav <- mean(subset(group0, group0$CN_level=="aav")$"pre.t0")+mean(subset(group0, group0$CN_level=="aav")$"delta")

g1t1bav <- mean(subset(group1, group1$CN_level=="bav")$"pre.t0")+mean(subset(group1, group1$CN_level=="bav")$"delta")
g1t1av <- mean(subset(group1, group1$CN_level=="av")$"pre.t0")+mean(subset(group1, group1$CN_level=="av")$"delta")
g1t1aav <- mean(subset(group1, group1$CN_level=="aav")$"pre.t0")+mean(subset(group1, group1$CN_level=="aav")$"delta")

all <- matrix(data=c(g0t0bav, g0t1bav, g0t0av, g0t1av, g0t0aav, g0t1aav,
       g1t0bav, g1t1bav, g1t0av, g1t1av, g1t0aav, g1t1aav), nrow = 2, ncol=6, byrow = TRUE)

barplot(all, beside=TRUE)
barplot(all[2,], beside=TRUE)
#Graphs
x1 <- rep(1, 6)
x2 <- rep(2,6)
y <- c(g0t0bav, g0t1bav, g0t0av, g0t1av, g0t0aav, g0t1aav,
       g1t0bav, g1t1bav, g1t0av, g1t1av, g1t0aav, g1t1aav)

plot(c(x1,x2), y, ylab="Model implied prejudice", xlab="Time points", xaxt="n", pch=19, col= c("blue", "blue", "blue", "red", "red", "red"))
axis(1, at=c(1,2), labels = c(1,2))
segments(x1, y[1:6], x2, y[7:12], col= c("blue", "blue", "blue", "red", "red", "red"), lty=c(2,1,3,2,1,3), lwd=c(3,3,3,3,3,3))
legend(x=1.4, y=.15, legend=c("CG below average CN", "CG average CN","CG above average CN", 
                       "EG below average CN", "EG average CN","EG above average CN"), 
       col=c("blue", "blue", "blue", "red", "red", "red"), lty=c(2,1,3,2,1,3), lwd=c(3,3,3,3,3,3), ncol=2, bty="n")


```

So, there is a significant main effect of CN (the higher CN, the more change). 

# Version 2

```{r}
stats::scatter.smooth(x=datfs$CN_t0, y=datfs$delta, xlab="Collective Narcissism", ylab="Change from t0 to t1", pch=19)
```


# Change in correlation
```{r}

r00 <- psych::corr.test(group0$CN_t0, group0$pre.t0)
r01 <- psych::corr.test(group0$CN_t1, group0$pre.t1)
r00
r01
r10 <- psych::corr.test(group1$CN_t0, group1$pre.t0)
r11 <- psych::corr.test(group1$CN_t1, group1$pre.t1)
r10
r11
```

